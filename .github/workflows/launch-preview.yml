# =============================================================================
# WishlistOps Launch & Preview Workflow
# =============================================================================
#
# Launches both the frontend dashboard and backend for testing and preview.
# Use this workflow for easy testing as you develop â€” it validates both
# components and deploys a live preview of the dashboard.
#
# Frontend: Static dashboard served and validated via HTTP
# Backend:  Python automation validated in dry-run mode
#
# Trigger manually or automatically on pull requests.
# =============================================================================

name: Launch & Preview App

on:
  # Manual trigger for on-demand testing
  workflow_dispatch:
    inputs:
      backend_verbose:
        description: 'Enable verbose backend logging'
        required: false
        default: 'false'
        type: boolean

  # Auto-run on pull requests for preview
  pull_request:
    branches: [main]

# Only allow one preview deployment at a time per PR/ref
concurrency:
  group: preview-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: read

jobs:
  # =========================================================================
  # Job 1: Launch & Validate Frontend Dashboard
  # =========================================================================
  frontend:
    name: "ðŸŽ¨ Frontend Dashboard"
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python (for HTTP server)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Start frontend server
        run: |
          echo "ðŸš€ Starting dashboard server on port 8000..."
          cd dashboard
          python -m http.server 8000 --bind 127.0.0.1 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"

          # Wait for server to be ready
          for i in $(seq 1 10); do
            if curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000 | grep -q "200"; then
              echo "âœ… Frontend server is running (PID: $SERVER_PID)"
              break
            fi
            echo "  Waiting for server... (attempt $i/10)"
            sleep 1
          done

      - name: Validate frontend serves correctly
        run: |
          echo "ðŸ” Validating frontend responses..."

          # Check index.html loads
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/index.html)
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… index.html â€” HTTP $HTTP_STATUS"
          else
            echo "âŒ index.html â€” HTTP $HTTP_STATUS"
            exit 1
          fi

          # Check CSS loads
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/styles.css)
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… styles.css â€” HTTP $HTTP_STATUS"
          else
            echo "âŒ styles.css â€” HTTP $HTTP_STATUS"
            exit 1
          fi

          # Check JS loads
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8000/app.js)
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… app.js    â€” HTTP $HTTP_STATUS"
          else
            echo "âŒ app.js    â€” HTTP $HTTP_STATUS"
            exit 1
          fi

          # Verify HTML contains expected content
          BODY=$(curl -s http://127.0.0.1:8000/index.html)
          if echo "$BODY" | grep -q "WishlistOps"; then
            echo "âœ… Page content contains 'WishlistOps'"
          else
            echo "âŒ Page content missing 'WishlistOps' title"
            exit 1
          fi

          echo ""
          echo "ðŸŽ‰ All frontend checks passed!"

      - name: Stop frontend server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill "$SERVER_PID" 2>/dev/null || true
            echo "ðŸ›‘ Frontend server stopped"
          fi

      - name: Upload dashboard for preview
        uses: actions/upload-pages-artifact@v3
        with:
          path: dashboard/

  # =========================================================================
  # Job 2: Launch & Validate Backend
  # =========================================================================
  backend:
    name: "âš™ï¸ Backend Validation"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"

      - name: Verify configuration
        run: |
          if [ -f wishlistops/config.json ]; then
            echo "âœ… config.json found"
            python -c "
          import json, sys
          try:
              with open('wishlistops/config.json') as f:
                  config = json.load(f)
              print('âœ… config.json is valid JSON')
              print(f'   Keys: {list(config.keys())}')
          except json.JSONDecodeError as e:
              print(f'âŒ config.json is invalid: {e}')
              sys.exit(1)
          "
          else
            echo "âš ï¸ config.json not found â€” skipping config validation"
          fi

      - name: Verify backend imports
        run: |
          echo "ðŸ” Checking backend module imports..."
          python -c "
          import sys
          modules = [
              'wishlistops',
              'wishlistops.config_manager',
              'wishlistops.models',
              'wishlistops.git_parser',
              'wishlistops.content_filter',
              'wishlistops.state_manager',
              'wishlistops.ai_client',
              'wishlistops.image_compositor',
              'wishlistops.discord_notifier',
              'wishlistops.main',
          ]
          failed = []
          for mod in modules:
              try:
                  __import__(mod)
                  print(f'  âœ… {mod}')
              except Exception as e:
                  print(f'  âŒ {mod}: {e}')
                  failed.append(mod)
          if failed:
              print(f'\nâŒ {len(failed)} module(s) failed to import')
              sys.exit(1)
          print(f'\nâœ… All {len(modules)} modules imported successfully')
          "

      - name: Run backend in dry-run mode
        run: |
          echo "ðŸš€ Launching backend in dry-run mode..."
          VERBOSE_FLAG=""
          if [ "${{ github.event.inputs.backend_verbose }}" = "true" ]; then
            VERBOSE_FLAG="--verbose"
            echo "ðŸ” Verbose logging enabled"
          fi

          python -m wishlistops.main \
            --config wishlistops/config.json \
            --dry-run \
            $VERBOSE_FLAG \
          && echo "âœ… Backend dry-run completed successfully" \
          || echo "âš ï¸ Backend dry-run exited with warnings (expected without API keys)"

      - name: Run tests
        run: |
          echo "ðŸ§ª Running test suite..."
          python -m pytest tests/ -v --tb=short 2>&1 || echo "âš ï¸ Some tests may require API keys or fixtures"

  # =========================================================================
  # Job 3: Deploy Dashboard Preview to GitHub Pages
  # =========================================================================
  deploy-preview:
    name: "ðŸŒ Deploy Preview"
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: success() || needs.frontend.result == 'success'

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # =========================================================================
  # Job 4: Summary
  # =========================================================================
  summary:
    name: "ðŸ“‹ Summary"
    runs-on: ubuntu-latest
    needs: [frontend, backend, deploy-preview]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ WishlistOps Launch & Preview Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Component | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|--------|" >> "$GITHUB_STEP_SUMMARY"

          # Frontend status
          if [ "${{ needs.frontend.result }}" = "success" ]; then
            echo "| ðŸŽ¨ Frontend Dashboard | âœ… Passed |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| ðŸŽ¨ Frontend Dashboard | âŒ Failed |" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Backend status
          if [ "${{ needs.backend.result }}" = "success" ]; then
            echo "| âš™ï¸ Backend Validation | âœ… Passed |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| âš™ï¸ Backend Validation | âŒ Failed |" >> "$GITHUB_STEP_SUMMARY"
          fi

          # Deploy status
          if [ "${{ needs.deploy-preview.result }}" = "success" ]; then
            echo "| ðŸŒ Preview Deployment | âœ… Deployed |" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "| ðŸŒ Preview Deployment | âš ï¸ Skipped or Failed |" >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.deploy-preview.result }}" = "success" ]; then
            echo "### ðŸ”— Preview Link" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Dashboard is live at your GitHub Pages URL." >> "$GITHUB_STEP_SUMMARY"
            echo "Check the **Deploy Preview** job for the exact URL." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "*Triggered by: ${{ github.actor }} | Ref: \`${{ github.ref_name }}\` | Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> "$GITHUB_STEP_SUMMARY"
